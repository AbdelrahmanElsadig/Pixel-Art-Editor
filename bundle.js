(()=>{"use strict";class t{constructor(t,e,o){this.width=t,this.height=e,this.pixels=o}static empty(e,o,i){let n=new Array(e*o).fill(i);return new t(e,o,n)}pixel(t,e){return this.pixels[t+e*this.width]}draw(e){let o=this.pixels.slice();for(let{x:t,y:i,color:n}of e)o[t+i*this.width]=n;return new t(this.width,this.height,o)}}function e(t,e,...o){let i=document.createElement(t);e&&Object.assign(i,e);for(let t of o)"string"!=typeof t?i.appendChild(t):i.appendChild(document.createTextNode(t));return i}class o{constructor(t,o){this.dom=e("canvas",{onmousedown:t=>this.mouse(t,o),ontouchstart:t=>this.touch(t,o)}),this.sync_state(t)}sync_state(t){this.picture!=t&&(function(t,e,o,i){null!=t&&t.width==e.width&&t.height==e.height||(o.width=e.width*i,o.height=e.height*i,t=null);let n=o.getContext("2d");for(let o=0;o<e.height;o++)for(let s=0;s<e.width;s++){let c=e.pixel(s,o);null!=t&&t.pixel(s,o)==c||(n.fillStyle=c,n.fillRect(s*i,o*i,i,i))}}(this.picture,t,this.dom,10),this.picture=t)}}function i(t,e){let o=e.getBoundingClientRect();return{x:Math.floor((t.clientX-o.left)/10),y:Math.floor((t.clientY-o.top)/10)}}o.prototype.mouse=function(t,e){if(0!=t.button)return;let o=i(t,this.dom),n=e(o);if(!n)return;let s=t=>{if(0==t.buttons)this.dom.removeEventListener("mousemove",s);else{let e=i(t,this.dom);if(e.x==o.x&&e.y==o.y)return;o=e,n(e)}};this.dom.addEventListener("mousemove",s)},o.prototype.touch=function(t,e){let o=i(t,this.dom),n=e(o);if(t.preventDefault(),!n)return;let s=t=>{let e=i(t.touches[0],this.dom);e.x==o.x&&e.y==o.y||(o=e,n(e))},c=()=>{this.dom.removeEventListener("touchmove",s),this.dom.removeEventListener("touchend",c)};this.dom.addEventListener("touchmove",s),this.dom.addEventListener("touchend",c)};class n{constructor(t,i){let{tools:n,controls:s,dispatch:c}=i;this.state=t,this.canvas=new o(t.picture,(t=>{let e=(0,n[this.state.tool])(t,this.state,c);if(e)return t=>e(t,this.state)})),this.controls=s.map((e=>new e(t,i))),this.dom=e("div",{tabIndex:0},this.canvas.dom,e("br"),...this.controls.reduce(((t,e)=>t.concat(" ",e.dom)),[])),this.dom.addEventListener("keydown",(t=>{let e="ldfrcp".split(""),o=document.querySelectorAll("option");e.forEach(((e,i)=>{if(t.key.toLowerCase()==e)return o[i].selected=!0,void(this.state.tool=o[i].value)})),t.ctrlKey&&"z"==t.key.toLowerCase()&&document.querySelector("button:last-child").click()}))}sync_state(t){this.state=t,this.canvas.sync_state(t.picture);for(let e of this.controls)e.sync_state(t)}}function s(t,e,o){let i=[];if(Math.abs(t.x-e.x)>Math.abs(t.y-e.y)){t.x>e.x&&([t,e]=[e,t]);let n=(e.y-t.y)/(e.x-t.x);for(let{x:s,y:c}=t;s<=e.x;s++)i.push({x:s,y:Math.round(c),color:o}),c+=n}else{t.y>e.y&&([t,e]=[e,t]);let n=(e.x-t.x)/(e.y-t.y);for(let{x:s,y:c}=t;c<=e.y;c++)i.push({x:Math.round(s),y:c,color:o}),s+=n}return i}const c=[{dx:1,dy:0},{dx:-1,dy:0},{dx:0,dy:-1},{dx:0,dy:1}];function l(o){let i=Math.min(100,o.width),n=Math.min(100,o.height);const s=e("canvas",{width:i,height:n}).getContext("2d");s.drawImage(o,0,0);let c=[],l=s.getImageData(0,0,i,n);function r(t){return t.toString(16).padStart(2,"0")}for(let t=0;t<l.length;t+=4){let[e,o,i]=l.slice(t,t+3);c.push("#"+r(e)+r(o)+r(i))}return new t(i,n,c)}const r={tool:"draw",color:"#000000",picture:t.empty(60,30,"#f0f0f0"),done:[],done_at:0},h={line:function(t,e,o){return i=>{let n=s(t,i,e.color);o({picture:e.picture.draw(n)})}},draw:function(t,e,o){function i(e,i){let n=s(t,e,i.color);t=e,o({picture:i.picture.draw(n)})}return i(t,e),i},fill:function({x:t,y:e},o,i){let n=o.picture.pixel(t,e),s=[{x:t,y:e,color:o.color}];for(let t=0;t<s.length;t++)for(let{dx:e,dy:i}of c){let c=s[t].x+e,l=s[t].y+i;c>=0&&c<o.picture.width&&l>=0&&l<o.picture.height&&o.picture.pixel(c,l)==n&&!s.some((t=>t.x==c&&t.y==l))&&s.push({x:c,y:l,color:o.color})}i({picture:o.picture.draw(s)})},rectangle:function(t,e,o){function i(i){let n=Math.min(t.x,i.x),s=Math.min(t.y,i.y),c=Math.max(t.x,i.x),l=Math.max(t.y,i.y),r=[];for(let t=s;t<l;t++)for(let o=n;o<c;o++)r.push({x:o,y:t,color:e.color});o({picture:e.picture.draw(r)})}return i(t),i},circle:function(t,e,o){function i(i){let n=Math.sqrt(Math.pow(t.x-i.x,2)+Math.pow(t.y-i.y,2)),s=Math.ceil(n),c=[];for(let o=-s;o<=s;o++)for(let i=-s;i<=s;i++){if(Math.sqrt(Math.pow(i,2)+Math.pow(o,2))>n)continue;let s=t.x+i,l=t.y+o;s<0||s>=e.picture.width||l<0||l>=e.picture.height||c.push({x:s,y:l,color:e.color})}o({picture:e.picture.draw(c)})}return i(t),i},pick:function(t,e,o){o({color:e.picture.pixel(t.x,t.y)})}},u=[class{constructor(t,{tools:o,dispatch:i}){this.select=e("select",{onchange:()=>i({tool:this.select.value})},...Object.keys(o).map((o=>e("option",{selected:o==t.tool},o)))),this.dom=e("label",null,"🖌 Tool: ",this.select)}sync_state(t){this.select.value=t.tool}},class{constructor(t,{dispatch:o}){this.input=e("input",{type:"color",value:t.color,onchange:()=>o({color:this.input.value})}),this.dom=e("label",null,"🎨 Color: ",this.input)}sync_state(t){this.input.value=t.color}},class{constructor(t){this.picture=t.picture,this.dom=e("button",{onclick:()=>this.save()},"💾 Save")}save(){let t=e("canvas");!function(t,e,o){e.width=1*t.width,e.height=1*t.height;const i=e.getContext("2d");for(let e=0;e<t.height;e++)for(let o=0;o<t.width;o++)i.fillStyle=t.pixel(o,e),i.fillRect(1*o,1*e,1,1)}(this.picture,t);let o=e("a",{href:t.toDataURL(),download:"pixelart.png"});document.body.appendChild(o),o.click(),o.remove()}sync_state(t){this.picture=t.picture}},class{constructor(t,{dispatch:o}){this.dom=e("button",{onclick:()=>function(t){let o=e("input",{type:"file",onchange:()=>function(t,o){if(null==t)return;let i=new FileReader;i.addEventListener("load",(()=>{let t=e("img",{onload:()=>o({picture:l(t)}),src:i.result})})),i.readAsDataURL(t)}(o.files[0],t)});document.body.appendChild(o),o.click(),o.remove()}(o)},"📁 Load")}sync_state(){}},class{constructor(t,{dispatch:o}){this.dom=e("button",{onclick:()=>o({undo:!0}),disabled:0==t.done.length},"⮪ Undo")}sync_state(t){this.dom.disabled=0==t.done.length}}];document.querySelector(".editor").appendChild(function({state:t=r,tools:e=h,controls:o=u}){let i=new n(t,{tools:e,controls:o,dispatch(e){t=function(t,e){return 1==e.undo?0==t.done.length?t:Object.assign({},t,{picture:t.done[0],done:t.done.slice(1),done_at:0}):e.picture&&t.done_at<Date.now()-1e3?Object.assign({},t,e,{done:[t.picture,...t.done],done_at:Date.now()}):Object.assign({},t,e)}(t,e),i.sync_state(t)}});return i.dom}({}))})();